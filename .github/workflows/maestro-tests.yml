name: Maestro E2E Tests

on:
  pull_request:
    paths:
      - 'mobile/**'
      - '.github/workflows/maestro-tests.yml'
  push:
    branches: [main]
    paths:
      - 'mobile/**'
      - '.github/workflows/maestro-tests.yml'
  workflow_dispatch:

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  test-ios:
    name: Maestro Tests (iOS)
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Install dependencies
        working-directory: ./mobile
        run: npm ci

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
          maestro --version

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Find available simulator
        run: |
          # List available simulators
          echo "Available simulators:"
          xcrun simctl list devices available | grep "iPhone"
          
          # Get the first available iPhone simulator with its UDID
          # Format: "    iPhone 16 Pro (C34612FC-89A5-4760-B346-131471430938) (Shutdown)"
          SIMULATOR_INFO=$(xcrun simctl list devices available | grep -i "iPhone" | head -1)
          
          if [ -z "$SIMULATOR_INFO" ]; then
            echo "Error: No iPhone simulators available"
            xcrun simctl list devices available
            exit 1
          fi
          
          # Extract device name (everything before the first parenthesis)
          DEVICE_NAME=$(echo "$SIMULATOR_INFO" | sed -E 's/^[[:space:]]+([^(]+).*/\1/' | xargs)
          
          # Extract UDID (between parentheses)
          SIM_UDID=$(echo "$SIMULATOR_INFO" | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          
          if [ -z "$DEVICE_NAME" ] || [ -z "$SIM_UDID" ]; then
            echo "Error: Could not parse simulator info: $SIMULATOR_INFO"
            exit 1
          fi
          
          echo "DEVICE_ID=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIM_UDID=$SIM_UDID" >> $GITHUB_ENV
          echo "Will use simulator: $DEVICE_NAME ($SIM_UDID)"

      - name: Build development build
        working-directory: ./mobile
        run: |
          echo "Building development build for simulator..."
          echo "This may take 10-20 minutes. The --wait flag will wait for completion."
          eas build --profile development --platform ios --non-interactive --wait
        continue-on-error: false
        # Note: You could optimize this by checking for existing builds first
        # or using build caching, but for simplicity we build fresh each time

      - name: Get build download URL
        working-directory: ./mobile
        id: get-build-url
        run: |
          # Get the latest build URL using Node.js
          BUILD_URL=$(node -e "
            const { execSync } = require('child_process');
            const output = execSync('eas build:list --platform ios --limit 1 --json --non-interactive', { encoding: 'utf-8' });
            const builds = JSON.parse(output);
            if (builds && builds.length > 0) {
              const build = builds[0];
              const url = build.artifacts?.buildUrl || build.artifacts?.url || build.url;
              if (url) {
                console.log(url);
              } else {
                console.error('No build URL found');
                process.exit(1);
              }
            } else {
              console.error('No builds found');
              process.exit(1);
            }
          ")
          if [ -z "$BUILD_URL" ]; then
            echo "Error: Could not get build URL"
            exit 1
          fi
          echo "BUILD_URL=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "Build URL: $BUILD_URL"

      - name: Download and extract build
        working-directory: ./mobile
        run: |
          # Download the build
          BUILD_URL="${{ steps.get-build-url.outputs.BUILD_URL }}"
          echo "Downloading from: $BUILD_URL"
          
          # Download to a temp file
          curl -L -o build_artifact "$BUILD_URL"
          
          # Check if it's a tar.gz or zip file
          if file build_artifact | grep -q "gzip\|tar\|zip"; then
            echo "Extracting archive..."
            # Try tar.gz first
            tar -xzf build_artifact 2>/dev/null || unzip -q build_artifact 2>/dev/null || true
          fi
          
          # Find the .app file (could be in current dir or extracted)
          APP_PATH=$(find . -name "*.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            # If no .app found, maybe it's already a .app directory?
            if [ -d "build_artifact" ]; then
              APP_PATH="build_artifact"
            else
              echo "Error: Could not find .app file"
              echo "Contents:"
              ls -la
              exit 1
            fi
          fi
          
          # Make path absolute
          APP_PATH=$(cd "$(dirname "$APP_PATH")" && pwd)/$(basename "$APP_PATH")
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV
          echo "Found app at: $APP_PATH"

      - name: Boot iOS Simulator
        run: |
          DEVICE_NAME="${{ env.DEVICE_ID }}"
          SIM_UDID="${{ env.SIM_UDID }}"
          echo "Booting simulator: $DEVICE_NAME ($SIM_UDID)"
          
          # Boot the simulator
          echo "Booting simulator..."
          xcrun simctl boot "$SIM_UDID" || echo "Simulator may already be booted"
          
          # Wait for simulator to be fully ready (with retries)
          echo "Waiting for simulator to be ready..."
          for i in {1..30}; do
            BOOT_STATUS=$(xcrun simctl list devices | grep "$SIM_UDID" | grep -o "Booted" || echo "")
            if [ -n "$BOOT_STATUS" ]; then
              echo "Simulator is booted and ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Error: Simulator failed to boot after 60 seconds"
              xcrun simctl list devices | grep "$SIM_UDID"
              exit 1
            fi
            echo "Waiting for boot... ($i/30)"
            sleep 2
          done
          
          # Final verification
          if ! xcrun simctl list devices | grep "$SIM_UDID" | grep -q "Booted"; then
            echo "Error: Simulator is not in Booted state"
            xcrun simctl list devices | grep "$SIM_UDID"
            exit 1
          fi
          
          echo "Simulator confirmed ready: $DEVICE_NAME ($SIM_UDID)"

      - name: Install app on simulator
        run: |
          SIM_UDID="${{ env.SIM_UDID }}"
          DEVICE_NAME="${{ env.DEVICE_ID }}"
          
          echo "Installing app on simulator: $SIM_UDID ($DEVICE_NAME)"
          echo "App path: ${{ env.APP_PATH }}"
          
          # Verify app path exists
          if [ ! -d "${{ env.APP_PATH }}" ]; then
            echo "Error: App path does not exist: ${{ env.APP_PATH }}"
            ls -la "$(dirname "${{ env.APP_PATH }}")" || true
            exit 1
          fi
          
          # Install the app
          xcrun simctl install "$SIM_UDID" "${{ env.APP_PATH }}"
          echo "App installed successfully"
          
          # Verify installation
          xcrun simctl listapps "$SIM_UDID" | grep -i "smartpantry" || echo "App installed (bundle ID may differ)"
      
      - name: Verify simulator is ready for Maestro
        run: |
          SIM_UDID="${{ env.SIM_UDID }}"
          DEVICE_NAME="${{ env.DEVICE_ID }}"
          
          echo "Verifying simulator is booted and ready..."
          xcrun simctl list devices | grep "$SIM_UDID" | grep "Booted"
          
          if [ $? -ne 0 ]; then
            echo "Error: Simulator is not booted"
            xcrun simctl list devices | grep "$SIM_UDID"
            exit 1
          fi
          
          echo "Simulator is ready: $DEVICE_NAME ($SIM_UDID)"
          
      - name: Run Maestro Tests
        working-directory: ./mobile
        run: |
          DEVICE_NAME="${{ env.DEVICE_ID }}"
          SIM_UDID="${{ env.SIM_UDID }}"
          
          echo "Running Maestro tests on: $DEVICE_NAME"
          echo "Simulator UDID: $SIM_UDID"
          
          # Maestro can auto-detect booted simulators, but we can also specify
          # Try without --device first (auto-detect), then with device name if needed
          if ! maestro test .maestro/; then
            echo "Auto-detect failed, trying with explicit device..."
            maestro test .maestro/ --device "$DEVICE_NAME"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results-ios
          path: mobile/.maestro/tests/
          retention-days: 7

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-screenshots-ios
          path: mobile/.maestro/tests/**/*.png
          retention-days: 7

  # Uncomment for Android testing
  # test-android:
  #   name: Maestro Tests (Android)
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 30
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #         cache-dependency-path: mobile/package-lock.json
  #
  #     - name: Setup Java
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: 'temurin'
  #         java-version: '17'
  #
  #     - name: Setup Android SDK
  #       uses: android-actions/setup-android@v3
  #
  #     - name: Create Android Emulator
  #       run: |
  #         echo "y" | sdkmanager "system-images;android-33;google_apis;x86_64"
  #         echo "no" | avdmanager create avd -n test_emulator -k "system-images;android-33;google_apis;x86_64"
  #
  #     - name: Start Android Emulator
  #       run: |
  #         emulator -avd test_emulator -no-window -no-audio -no-boot-anim &
  #         adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed | tr -d '\r') ]]; do sleep 1; done'
  #         adb shell input keyevent 82
  #
  #     - name: Install Maestro
  #       run: |
  #         curl -Ls "https://get.maestro.mobile.dev" | bash
  #         export PATH="$PATH:$HOME/.maestro/bin"
  #         echo "$HOME/.maestro/bin" >> $GITHUB_PATH
  #
  #     - name: Build and Install App
  #       working-directory: ./mobile
  #       run: |
  #         eas build --profile development --platform android --non-interactive
  #         # Download and install app here
  #
  #     - name: Run Maestro Tests
  #       working-directory: ./mobile
  #       run: |
  #         maestro test .maestro/ --device "test_emulator"
  #
  #     - name: Upload test results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: maestro-results-android
  #         path: mobile/.maestro/tests/
  #         retention-days: 7
